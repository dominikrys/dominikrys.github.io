<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Dominik Rys ">
<meta name="description" content="Motivation During my last internship, I&amp;rsquo;ve been tasked with designing and deploying infrastructure for monitoring a cluster of machines that were used for performance testing. I wrote a blog post detailing high-level choices about it which you can check out here. The post also includes justifications for why I chose to deploy everything in Docker, and why I chose to work with Grafana and InfluxDB as the front-end and time-series database, respectively." />
<meta name="keywords" content="blog, software, engineering, software engineering, devops, software development, computer science, devops, security, docker, influxdb, grafana, traefik" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://dominikrys.com/posts/2020/12/setting-up-a-tls-secured-monitoring-solution-in-docker-using-influxdb-grafana-and-traefik/" />


    <title>
        
            Setting up a TLS-Secured Monitoring Solution in Docker using InfluxDB, Grafana and Traefik :: Dominik Rys 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://dominikrys.com/main.d7bdd8ee18bfbf4c605488a7e5b1b92cd980dfeed2bdaeab4dd5e931a7a78bc0.css">




    <link rel="apple-touch-icon" sizes="180x180" href="https://dominikrys.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://dominikrys.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://dominikrys.com/favicon-16x16.png">
    <link rel="manifest" href="https://dominikrys.com/site.webmanifest">
    <link rel="mask-icon" href="https://dominikrys.com/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://dominikrys.com/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">



<meta itemprop="name" content="Setting up a TLS-Secured Monitoring Solution in Docker using InfluxDB, Grafana and Traefik">
<meta itemprop="description" content="Motivation During my last internship, I&rsquo;ve been tasked with designing and deploying infrastructure for monitoring a cluster of machines that were used for performance testing. I wrote a blog post detailing high-level choices about it which you can check out here. The post also includes justifications for why I chose to deploy everything in Docker, and why I chose to work with Grafana and InfluxDB as the front-end and time-series database, respectively."><meta itemprop="datePublished" content="2020-12-01T12:51:48&#43;01:00" />
<meta itemprop="dateModified" content="2020-12-01T12:51:48&#43;01:00" />
<meta itemprop="wordCount" content="1849"><meta itemprop="image" content="https://dominikrys.com"/>
<meta itemprop="keywords" content="devops,security,docker,influxdb,grafana,traefik," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://dominikrys.com"/>

<meta name="twitter:title" content="Setting up a TLS-Secured Monitoring Solution in Docker using InfluxDB, Grafana and Traefik"/>
<meta name="twitter:description" content="Motivation During my last internship, I&rsquo;ve been tasked with designing and deploying infrastructure for monitoring a cluster of machines that were used for performance testing. I wrote a blog post detailing high-level choices about it which you can check out here. The post also includes justifications for why I chose to deploy everything in Docker, and why I chose to work with Grafana and InfluxDB as the front-end and time-series database, respectively."/>




    <meta property="og:title" content="Setting up a TLS-Secured Monitoring Solution in Docker using InfluxDB, Grafana and Traefik" />
<meta property="og:description" content="Motivation During my last internship, I&rsquo;ve been tasked with designing and deploying infrastructure for monitoring a cluster of machines that were used for performance testing. I wrote a blog post detailing high-level choices about it which you can check out here. The post also includes justifications for why I chose to deploy everything in Docker, and why I chose to work with Grafana and InfluxDB as the front-end and time-series database, respectively." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dominikrys.com/posts/2020/12/setting-up-a-tls-secured-monitoring-solution-in-docker-using-influxdb-grafana-and-traefik/" /><meta property="og:image" content="https://dominikrys.com"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-01T12:51:48&#43;01:00" />
<meta property="article:modified_time" content="2020-12-01T12:51:48&#43;01:00" />







    <meta property="article:published_time" content="2020-12-01 12:51:48 &#43;0100 &#43;0100" />








    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://dominikrys.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   background-color:#67a2c9;
                   animation-duration:2s;">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
            <nav class="menu">
    <ul class="menu__inner"><li><a href="https://dominikrys.com/posts/">Blog</a></li>
    </ul>
</nav>

            <span class="menu-trigger">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M0 0h24v24H0z" fill="none" />
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                </svg>
            </span>
            
        </span>
    </span>

    <link rel="apple-touch-icon" sizes="180x180" href="https://dominikrys.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://dominikrys.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://dominikrys.com/favicon-16x16.png">
    <link rel="manifest" href="https://dominikrys.com/site.webmanifest">
    <link rel="mask-icon" href="https://dominikrys.com/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
</header>

            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        9 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://dominikrys.com/posts/2020/12/setting-up-a-tls-secured-monitoring-solution-in-docker-using-influxdb-grafana-and-traefik/">Setting up a TLS-Secured Monitoring Solution in Docker using InfluxDB, Grafana and Traefik</a>
      </h1>

      

      
        <hr />
        <aside id="toc">
          <div class="toc-title">Table of Contents</div>
          <nav id="TableOfContents">
  <ul>
    <li><a href="#motivation">Motivation</a></li>
    <li><a href="#setting-up-grafana-and-influxdb">Setting up Grafana and InfluxDB</a>
      <ul>
        <li><a href="#additional-configuration">Additional configuration</a></li>
      </ul>
    </li>
    <li><a href="#securing-containers-using-traefik">Securing containers using Traefik</a>
      <ul>
        <li><a href="#traefik-labels">Traefik labels</a></li>
        <li><a href="#traefik-with-other-containers">Traefik with other containers</a></li>
        <li><a href="#traefik-container-configuration">Traefik container configuration</a></li>
      </ul>
    </li>
    <li><a href="#further-improvements">Further improvements</a></li>
  </ul>
</nav>
        </aside>
        <hr />

      <div class="post-content">
        <p><img src="img/diagram.png" alt="Architecture Diagram"></p>
<h2 id="motivation">Motivation</h2>
<p>During my last internship, I&rsquo;ve been tasked with designing and deploying infrastructure for monitoring a cluster of machines that were used for performance testing. I wrote a blog post detailing high-level choices about it which you can check out <a href="https://dominikrys.com/posts/2020/09/monitoring-corda-nodes-using-grafana-influxdb-and-telegraf/" title="Monitoring Corda Nodes">here</a>. The post also includes justifications for why I chose to deploy everything in Docker, and why I chose to work with <a href="https://grafana.com/">Grafana</a> and <a href="https://www.influxdata.com/products/influxdb/">InfluxDB</a> as the front-end and time-series database, respectively.</p>
<p>It&rsquo;s relatively straightforward to write and deploy a Docker compose application with just Grafana and InfluxDB. There are many ready-made <code>docker-compose.yml</code> files that can be found online, as well as various tutorials and blog posts which explain the details. The main difficulty was in getting the application secured by issuing and renewing TLS certificates. My initial idea was to manually issue and set TLS certificates as described e.g. in the <a href="https://docs.influxdata.com/influxdb/v1.7/administration/https_setup/">InfluxDB documentation</a>, but this kind of approach wouldn&rsquo;t be maintainable in the long run.</p>
<p>This is where <a href="https://traefik.io/traefik/">Traefik</a> came in - it&rsquo;s an edge router which acts as a reverse proxy into your Docker compose application. More importantly, it aims to &ldquo;make networking boring&rdquo;, which in our case is achieved by <strong>automatically issuing and renewing TLS certificates from <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a></strong> - perfect! I&rsquo;ll describe how to set it up in this post.</p>
<p>Throughout the post, I&rsquo;ll also describe small improvements that could be made to the deployment I describe, as well as describe small quirks I found when working with the described tools. Note that Traefik works with all Docker containers, so this post can still apply if you for example use <a href="https://prometheus.io/">Prometheus</a> instead of InfluxDB as your time-series database.</p>
<p>For the finished all-in-one deployment of Grafana, InfluxDB and Traefik that this post will build up to, I&rsquo;ve provided this GitHub repo: <a href="https://github.com/dominikrys/docker-influxdb-grafana-traefik">Secure Monitoring Solution in Docker</a>.</p>
<h2 id="setting-up-grafana-and-influxdb">Setting up Grafana and InfluxDB</h2>
<p>Setting up Grafana and InfluxDB on Docker is pretty straightforward. Here&rsquo;s a <code>docker-compose.yml</code> that will do just that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>

<span style="color:#f92672">services</span>:
    <span style="color:#f92672">influxdb</span>:
        <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">influxdb</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">influxdb:1.8.3-alpine</span>
        <span style="color:#f92672">ports</span>:
            - <span style="color:#ae81ff">8086</span>:<span style="color:#ae81ff">8086</span>
        <span style="color:#f92672">volumes</span>:
            - <span style="color:#ae81ff">influxdb-data:/var/lib/influxdb</span>
        <span style="color:#f92672">environment</span>:
            <span style="color:#f92672">INFLUXDB_DB</span>: <span style="color:#ae81ff">example_db</span>

            <span style="color:#f92672">INFLUXDB_ADMIN_USER</span>: <span style="color:#ae81ff">admin</span>
            <span style="color:#f92672">INFLUXDB_ADMIN_PASSWORD</span>: <span style="color:#ae81ff">influxdb-admin</span>
        <span style="color:#f92672">networks</span>:
            - <span style="color:#ae81ff">monitoring</span>

    <span style="color:#f92672">grafana</span>:
        <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">grafana</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">grafana/grafana:7.3.4</span>
        <span style="color:#f92672">ports</span>:
            - <span style="color:#ae81ff">3000</span>:<span style="color:#ae81ff">3000</span>
        <span style="color:#f92672">volumes</span>:
          - <span style="color:#ae81ff">grafana-data:/var/lib/grafana</span>
        <span style="color:#f92672">environment</span>:
            <span style="color:#f92672">GF_SECURITY_ADMIN_USER</span>: <span style="color:#ae81ff">grafana</span>
            <span style="color:#f92672">GF_SECURITY_ADMIN_PASSWORD</span>: <span style="color:#ae81ff">grafana-admin</span>
        <span style="color:#f92672">networks</span>:
            - <span style="color:#ae81ff">monitoring</span>
        <span style="color:#f92672">depends_on</span>:
            - <span style="color:#ae81ff">influxdb</span>

<span style="color:#f92672">networks</span>:
    <span style="color:#f92672">monitoring</span>:
        <span style="color:#f92672">driver</span>: <span style="color:#ae81ff">bridge</span>

<span style="color:#f92672">volumes</span>:
    <span style="color:#f92672">influxdb-data</span>:
        <span style="color:#f92672">external</span>: <span style="color:#66d9ef">false</span>

    <span style="color:#f92672">grafana-data</span>:
        <span style="color:#f92672">external</span>: <span style="color:#66d9ef">false</span>
</code></pre></div><p>This simple Docker compose application creates Grafana and InfluxDB containers, creates persistent volumes for them so data will be saved if they&rsquo;re restarted, and sets up a networking bridge so the containers can communicate between each other (in favour of the legacy <a href="https://docs.docker.com/network/links/"><code>links</code></a> command that some old setups use).</p>
<p>To start up the containers, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker-compose up
</code></pre></div><p>Grafana can then be accessed at <a href="http://localhost:3000/"><code>http://localhost:3000</code></a> and InfluxDB at <a href="http://localhost:8086/"><code>http://localhost:8086</code></a>. You can go ahead and send some data to InfluxDB (e.g. with <a href="https://www.influxdata.com/time-series-platform/telegraf/">Telegraf</a>) to make sure it works. InfluxDB will need to be set up as a data source manually in Grafana, however it can be automated as I&rsquo;ll describe later.</p>
<p>The database specified by the <code>INFLUXDB_DB</code> environment variable will be created when InfluxDB is initialised. This is poorly documented sadly, but most of the details are included in <a href="https://github.com/influxdata/influxdata-docker/pull/102">this InfluxDB PR</a>.</p>
<p>The admin account details are provided in the <code>docker-compose.yml</code> above and should be changed to something secure. For ideas on how to store them securely, I recommend looking at <a href="https://docs.docker.com/engine/swarm/secrets/">Docker secrets</a> or <a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">Ansible Vault</a>.</p>
<h3 id="additional-configuration">Additional configuration</h3>
<p>I&rsquo;ve decided to use the <code>alpine</code> image variant for InfluxDB, mostly due to its smaller footprint. It&rsquo;ll be sufficient for most uses. Grafana uses an Alpine base image by default, and that&rsquo;s also the one that&rsquo;s <a href="https://grafana.com/docs/grafana/latest/installation/docker/#alpine-image-recommended">recommended</a>. The &ldquo;Image Variants&rdquo; section of the <a href="https://hub.docker.com/_/influxdb">InfluxDB docker image documentation</a> explains the image variants in more depth.</p>
<p>This kind of configuration is the foundation of your Grafana and InfluxDB monitoring setup. For now, feel free to change any settings using the appropriate environment variables - I found this way of configuring containers to be much cleaner than mounting a config file into the container, especially once we add Traefik with its labels to the deployment.</p>
<p>To configure Grafana and InfluxDB using environment variables:</p>
<ul>
<li>
<p><strong>InfluxDB:</strong> the format for the environment variables is <code>INFLUXDB_SECTION_NAME</code>, and all dashes (<code>-</code>) are replaced with underscores (<code>_</code>). Certain settings don&rsquo;t have sections, in which case the section part can be omitted.</p>
</li>
<li>
<p><strong>Grafana:</strong> the format for the environment variables is <code>GF_SECTION_NAME</code>, where full stops (<code>.</code>) and dashes (<code>-</code>) should be replaced by underscores (<code>_</code>).</p>
</li>
</ul>
<h2 id="securing-containers-using-traefik">Securing containers using Traefik</h2>
<p>Initially, I found how to secure the described Docker compose deployment with Traefik from <a href="https://www.grzegorowski.com/secure-docker-grafana-container-with-ssl-through-traefik-proxy">Jan Grzegorowski&rsquo;s blog post</a>. I highly recommend reading his post if anything is not clear here (I won&rsquo;t be offended).</p>
<p>As described already, Traefik is a cloud-native edge router which will serve as a reverse proxy in our Docker compose application. It will automatically issue and renew TLS certificates, so the traffic to and from our Docker containers will be encrypted. Luckily it&rsquo;s also quite straightforward to configure using <a href="https://doc.traefik.io/traefik/providers/docker/">labels</a>, and the entire configuration can be kept inside one <code>docker-compose.yml</code> file.</p>
<p>Adapting the above example <code>docker-compose.yml</code> to work with Traefik, we get:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>

<span style="color:#f92672">services</span>:
    <span style="color:#f92672">influxdb</span>:
        <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">influxdb</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">influxdb:1.8.3-alpine</span>
        <span style="color:#f92672">volumes</span>:
            - <span style="color:#ae81ff">influxdb-data:/var/lib/influxdb</span>
        <span style="color:#f92672">networks</span>:
            - <span style="color:#ae81ff">monitoring</span>
        <span style="color:#f92672">labels</span>:
            - <span style="color:#e6db74">&#34;traefik.http.routers.influxdb-ssl.entryPoints=influxdb-port&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.influxdb-ssl.rule=host(`YOUR_DOMAIN`)&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.influxdb-ssl.tls=true&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.influxdb-ssl.tls.certResolver=lets-encrypt-ssl&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.influxdb-ssl.service=influxdb-ssl&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.services.influxdb-ssl.loadBalancer.server.port=8086&#34;</span>

    <span style="color:#f92672">grafana</span>:
        <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">grafana</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">grafana/grafana:7.3.4</span>
        <span style="color:#f92672">volumes</span>:
          - <span style="color:#ae81ff">grafana-data:/var/lib/grafana</span>
        <span style="color:#f92672">networks</span>:
            - <span style="color:#ae81ff">monitoring</span>
        <span style="color:#f92672">depends_on</span>:
            - <span style="color:#ae81ff">influxdb</span>
        <span style="color:#f92672">labels</span>:
            - <span style="color:#e6db74">&#34;traefik.http.routers.grafana.entryPoints=port80&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.grafana.rule=host(`YOUR_DOMAIN`)&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.grafana.middlewares=grafana-redirect&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.middlewares.grafana-redirect.redirectScheme.scheme=https&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.middlewares.grafana-redirect.redirectScheme.permanent=true&#34;</span>

            - <span style="color:#e6db74">&#34;traefik.http.routers.grafana-ssl.entryPoints=port443&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.grafana-ssl.rule=host(`YOUR_DOMAIN`)&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.grafana-ssl.tls=true&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.grafana-ssl.tls.certResolver=lets-encrypt-ssl&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.routers.grafana-ssl.service=grafana-ssl&#34;</span>
            - <span style="color:#e6db74">&#34;traefik.http.services.grafana-ssl.loadBalancer.server.port=3000&#34;</span>

    <span style="color:#f92672">traefik</span>:
        <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">traefik</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">traefik:v2.3.4</span>
        <span style="color:#f92672">volumes</span>:
            - <span style="color:#ae81ff">traefik-data:/letsencrypt</span>
            - <span style="color:#ae81ff">/var/run/docker.sock:/var/run/docker.sock</span>
        <span style="color:#f92672">networks</span>:
            - <span style="color:#ae81ff">monitoring</span>
        <span style="color:#f92672">ports</span>:
            - <span style="color:#e6db74">&#34;80:80&#34;</span>
            - <span style="color:#e6db74">&#34;443:443&#34;</span>
            - <span style="color:#e6db74">&#34;8086:8086&#34;</span>
        <span style="color:#f92672">command</span>:
            - <span style="color:#e6db74">&#34;--providers.docker=true&#34;</span>

            - <span style="color:#e6db74">&#34;--entryPoints.port443.address=:443&#34;</span>
            - <span style="color:#e6db74">&#34;--entryPoints.port80.address=:80&#34;</span>
            - <span style="color:#e6db74">&#34;--entryPoints.influxdb-port.address=:8086&#34;</span>

            - <span style="color:#e6db74">&#34;--certificatesResolvers.lets-encrypt-ssl.acme.tlsChallenge=true&#34;</span>
            - <span style="color:#e6db74">&#34;--certificatesResolvers.lets-encrypt-ssl.acme.storage=/letsencrypt/acme.json&#34;</span>
            - <span style="color:#e6db74">&#34;--certificatesresolvers.lets-encrypt-ssl.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory&#34;</span>
            - <span style="color:#e6db74">&#34;--certificatesResolvers.lets-encrypt-ssl.acme.email=YOUR-EMAIL@website.com&#34;</span>

<span style="color:#f92672">networks</span>:
    <span style="color:#f92672">monitoring</span>:
        <span style="color:#f92672">driver</span>: <span style="color:#ae81ff">bridge</span>

<span style="color:#f92672">volumes</span>:
    <span style="color:#f92672">influxdb-data</span>:
        <span style="color:#f92672">external</span>: <span style="color:#66d9ef">false</span>

    <span style="color:#f92672">grafana-data</span>:
        <span style="color:#f92672">external</span>: <span style="color:#66d9ef">false</span>

    <span style="color:#f92672">traefik-data</span>:
        <span style="color:#f92672">external</span>: <span style="color:#66d9ef">false</span>
</code></pre></div><p>There&rsquo;s quite a lot going on here! I&rsquo;ll try to break it down bit by bit.</p>
<p>Notice that the ports for the Grafana and InfluxDB containers have been moved to the Traefik container. This is because Traefik will now act as an entry point for our Docker compose application, and will route traffic to other containers.</p>
<h3 id="traefik-labels">Traefik labels</h3>
<p>We create some labels in the InfluxDB container for our Traefik configuration:</p>
<ul>
<li>
<p><code>- &quot;traefik.http.routers.influxdb-ssl.entryPoints=influxdb-port&quot;</code>: set the container&rsquo;s &ldquo;entrypoint&rdquo; using a <a href="https://doc.traefik.io/traefik/routing/routers/">Traefik router</a>. It corresponds to the appropriate label in the Traefik container - here I called it <code>influxdb-port</code>. The fourth part of the label can have any arbitrary name (here I chose <code>influxdb-ssl</code>).</p>
</li>
<li>
<p><code>- &quot;traefik.http.routers.influxdb-ssl.rule=host(`YOUR_DOMAIN`)&quot;</code>: the start of the TLS configuration - fill in the domain of where this application will be hosted. If you&rsquo;re testing locally, it can be set to <code>localhost</code> or variations of it (e.g. <code>monitoring.docker.localhost</code>).</p>
</li>
<li>
<p><code>- &quot;traefik.http.routers.influxdb-ssl.tls=true&quot;</code>: flag for enabling TLS for this container. Changing this to <code>false</code> can be useful when you&rsquo;re testing the deployment locally, and want to send data to InfluxDB from applications that can&rsquo;t be set to ignore TLS certificates. This is because TLS certificates can&rsquo;t be issued for <code>localhost</code> domains by Traefik as they don&rsquo;t end with a valid top-level domain.</p>
</li>
<li>
<p><code>- &quot;traefik.http.routers.influxdb-ssl.tls.certResolver=lets-encrypt-ssl&quot;</code>: the name of the certificate resolver - make sure it matches the name of the certificate resolver set in the Traefik container.</p>
</li>
<li>
<p><code>- &quot;traefik.http.routers.influxdb-ssl.service=influxdb-ssl&quot;</code>: set the name of the <a href="https://doc.traefik.io/traefik/routing/services/">Traefik service</a> for this container. This will be the name that the other labels in this container have been given.</p>
</li>
<li>
<p><code>- &quot;traefik.http.services.influxdb-ssl.loadBalancer.server.port=8086&quot;</code>: sets any ports that Traefik should route traffic to for this container. This is done using a <a href="https://doc.traefik.io/traefik/routing/services/">Traefik service</a>, and is effectively a way to tell Traefik how to reach the service. This will be specified by the container&rsquo;s Docker image, so be sure to check which port to use for any other images.</p>
</li>
</ul>
<h3 id="traefik-with-other-containers">Traefik with other containers</h3>
<p>The Grafana TLS configuration is largely the same, with the appropriate port numbers and router names changed.</p>
<p>Since we want Grafana to show up when the domain is visited, the following labels handle HTTP to HTTPS redirection using Traefik:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">- <span style="color:#e6db74">&#34;traefik.http.routers.grafana.entryPoints=port80&#34;</span>
- <span style="color:#e6db74">&#34;traefik.http.routers.grafana.rule=host(`YOUR_DOMAIN`)&#34;</span>
- <span style="color:#e6db74">&#34;traefik.http.routers.grafana.middlewares=grafana-redirect&#34;</span>
- <span style="color:#e6db74">&#34;traefik.http.middlewares.grafana-redirect.redirectScheme.scheme=https&#34;</span>
- <span style="color:#e6db74">&#34;traefik.http.middlewares.grafana-redirect.redirectScheme.permanent=true&#34;</span>
</code></pre></div><p>Here we set up <a href="https://doc.traefik.io/traefik/middlewares/overview/">Traefik middlewares</a> which are a means to tweak requests (e.g. redirect from one port to another) before it gets passed to the Traefik service. The configuration is fairly straightforward.</p>
<h3 id="traefik-container-configuration">Traefik container configuration</h3>
<p>Finally, we set up the actual Traefik container:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">traefik</span>:
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">traefik</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">traefik:v2.3.4</span>
    <span style="color:#f92672">volumes</span>:
        - <span style="color:#ae81ff">traefik-data:/letsencrypt</span>
        - <span style="color:#ae81ff">/var/run/docker.sock:/var/run/docker.sock</span>
    <span style="color:#f92672">networks</span>:
        - <span style="color:#ae81ff">monitoring</span>
    <span style="color:#f92672">ports</span>:
        - <span style="color:#e6db74">&#34;80:80&#34;</span>
        - <span style="color:#e6db74">&#34;443:443&#34;</span>
        - <span style="color:#e6db74">&#34;8086:8086&#34;</span>
</code></pre></div><p>First, we set up a persistent volume for the <code>/letencrypt</code> directory which will store any TLS certificates that Traefik obtains from Let&rsquo;s Encrypt. This is important so that certificates don&rsquo;t have to be reissued when the container is restarted.</p>
<p>Next, we need to mount the Docker socket into the container so that Traefik can get <a href="https://docs.traefik.io/providers/docker/#docker-api-access">Docker&rsquo;s dynamic configuration</a>.</p>
<p>We also open all the ports whose traffic we want to route through Traefik.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">command</span>:
    - <span style="color:#e6db74">&#34;--providers.docker=true&#34;</span>

    - <span style="color:#e6db74">&#34;--entryPoints.port443.address=:443&#34;</span>
    - <span style="color:#e6db74">&#34;--entryPoints.port80.address=:80&#34;</span>
    - <span style="color:#e6db74">&#34;--entryPoints.influxdb-port.address=:8086&#34;</span>
</code></pre></div><p>We set the <code>providers.docker</code> command to true since we&rsquo;re using Docker. We also set up some <a href="https://doc.traefik.io/traefik/routing/entrypoints/">Traefik entrypoints</a> to open connections for incoming requests, which correspond to the ports we&rsquo;ve opened in the container.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">- <span style="color:#e6db74">&#34;--certificatesResolvers.lets-encrypt-ssl.acme.tlsChallenge=true&#34;</span>
- <span style="color:#e6db74">&#34;--certificatesResolvers.lets-encrypt-ssl.acme.storage=/letsencrypt/acme.json&#34;</span>
- <span style="color:#e6db74">&#34;--certificatesresolvers.lets-encrypt-ssl.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory&#34;</span>
- <span style="color:#e6db74">&#34;--certificatesResolvers.lets-encrypt-ssl.acme.email=YOUR-EMAIL@website.com&#34;</span>
</code></pre></div><p>Finally we set up the certificate resolver that will renew and issue our TLS certificates. Note that the second part of these labels can be set to any arbitrary name, and isn&rsquo;t used anywhere.</p>
<p>The <code>caServer</code> label determines which Certificate Authority to request TLS certificates from. Since we&rsquo;re getting them from <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a>, this can either be set to Let&rsquo;s Encrypt&rsquo;s staging (<code>https://acme-staging-v02.api.letsencrypt.org/directory</code>) server or production (<code>https://acme-v02.api.letsencrypt.org/directory</code>) server. There is a <a href="https://letsencrypt.org/docs/rate-limits/">limit of 5 certificates per week from Let&rsquo;s Encrypt&rsquo;s production server</a>, so it may be a good idea to use the staging server for testing. For more info on the Let&rsquo;s Encrypt staging environment and Traefik, check the note under <a href="https://doc.traefik.io/traefik/v2.0/user-guides/docker-compose/acme-tls/#setup">this Traefik docs page</a>.</p>
<p>The <code>email</code> label is necessary so that Let&rsquo;s Encrypt can contact you about <a href="https://cert-manager.io/docs/configuration/acme/#creating-a-basic-acme-issuer">expiring certificates and any issues related to your account</a>.</p>
<p>That&rsquo;s it! Your Docker containers are now secured, and traffic that will be sent to and from them will be encrypted.</p>
<h2 id="further-improvements">Further improvements</h2>
<p>There are a couple of small improvements that can be made to the Docker application at this point. Many of the improvements have been implemented in the mentioned <a href="https://github.com/dominikrys/docker-influxdb-grafana-traefik">GitHub repository</a> mentioned at the start of this post.</p>
<ul>
<li>
<p><code>volumes</code> configurations can be expanded to their verbose form for better readability. This can help with understanding what kind of mount is used, as it&rsquo;s not immediately obvious with the <a href="https://docs.docker.com/compose/compose-file/#short-syntax-3">short syntax</a>.</p>
</li>
<li>
<p>An <code>.env</code> file can be added alongside the <code>docker-compose.yml</code> file to store some common variables which are used throughout the <code>docker-compose.yml</code>, to avoid repetition.</p>
</li>
<li>
<p><code>restart: always</code> can be added to the Docker containers so that they&rsquo;re restarted on boot.</p>
</li>
<li>
<p>Grafana can automatically set up data sources specified under <code>grafana/provisioning/datasources</code>. Other aspects can also be provisioned in a similar manner, including plugins, dashboards, and alert notification channels. For more info, see <a href="https://grafana.com/docs/grafana/latest/administration/provisioning/">Grafana provisoning</a>.</p>
</li>
<li>
<p>InfluxDB will run shell scripts located in the <code>docker-entrypoint-initdb.d</code> directory on startup. InfluxQL <code>.iql</code> files can also be included there, but I wouldn&rsquo;t recommend it as they&rsquo;re much less flexible than shell scripts and can lead to non-obvious issues.</p>
</li>
</ul>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://dominikrys.com/tags/devops/">devops</a></span>
        <span class="tag"><a href="https://dominikrys.com/tags/security/">security</a></span>
        <span class="tag"><a href="https://dominikrys.com/tags/docker/">docker</a></span>
        <span class="tag"><a href="https://dominikrys.com/tags/influxdb/">influxdb</a></span>
        <span class="tag"><a href="https://dominikrys.com/tags/grafana/">grafana</a></span>
        <span class="tag"><a href="https://dominikrys.com/tags/traefik/">traefik</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        1849 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2020-12-01 11:51 &#43;0000
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        <div class="pagination__title">
            <span class="pagination__title-h"></span>
            <hr />
        </div>

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://dominikrys.com/posts/2021/02/how-to-debug-srslte/">
                    <span class="button__icon">←</span>
                    <span class="button__text">How to Debug srsLTE</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://dominikrys.com/posts/2020/09/monitoring-corda-nodes-using-grafana-influxdb-and-telegraf/">
                    <span class="button__text">Monitoring Corda Nodes Using Grafana, InfluxDB, and Telegraf</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    
      
        <div id="comments">
          <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "dominikrys" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
      
    

    

  </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2021</span>
            <span><a href="https://dominikrys.com">Dominik Rys</a></span>
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span><span><a href="https://dominikrys.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://dominikrys.com/bundle.min.2ce64ea6ea44a72b13dd812fc2eb5cca3efe878cce258a47c137c17edf46e0602a05e422b618a5b80b5939c731b7a293351c2f2222a21f6ee27e54a8448dd20e.js" integrity="sha512-LOZOpupEpysT3YEvwutcyj7&#43;h4zOJYpHwTfBft9G4GAqBeQithiluAtZOccxt6KTNRwvIiKiH27iflSoRI3SDg=="></script>



    </body>
</html>
